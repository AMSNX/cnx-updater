@echo off
REM MODIFIQUE ESSAS VARIÁVEIS DE ACORDO COM SUA NECESSIDADE
set SWFWFold=C:\#Unbrick\2-PC Apps\EmmcHaccGen\FW

REM NAO MEXA DAQUI PRA BAIXO!

set VAPU=
set VPROD=
set VVER=
set VVER2=%1
set VSTANDALONE=0

if "%1"=="" goto uso
goto prereq

:uso
cls
echo.
echo Erro eo executar o script!
echo.
echo.
echo Como usar este script?
echo Execute o script passando como parametro a versao do FIRMWARE DO SWITCH.
echo Exemplo: #Start.bat 15.0.1
echo.
echo Voce deseja informar a versao do firmware agora?
echo Informe o firmware usando o padrao X.X.X ou 3 para encerrar o script!
echo.
SET /P VVER2=Versao do firmware: 
if "%VVER2%"=="" goto uso
if "%VVER2%"=="3" goto fim

rem goto fimerro

:prereq
cls
if not exist "prod.keys" (
  echo.
  echo Erro de prerequisitos!
  echo Coloque o arquivo PROD.KEYS na mesma pasta deste script!
  echo.
  pause
  cls
  goto prereq
)

if not exist "prodinfo.dec" (
  echo.
  echo Erro de prerequisitos!
  echo Coloque o arquivo PRODINFO.DEC na mesma pasta deste script!
  echo.
  pause
  cls
  goto prereq
)

if not exist "donor_prod.keys" (
  echo.
  echo Erro de prerequisitos!
  echo Coloque o arquivo DONOR_PROD.KEYS na mesma pasta deste script!
  echo.
  pause
  cls
  goto prereq
)

if not exist "donor_rawnand.bin" (
  echo.
  echo Erro de prerequisitos!
  echo Coloque o arquivo DONOR_RAWNAND.BIN na mesma pasta deste script!
  echo.
  pause
  cls
  goto prereq
)

if not exist "%SWFWFold%%VVER2%\" (
   echo.
   echo Erro de prerequisitos!
   echo Crie a pasta "%SWFWFold%%VVER2%\" e coloque os arquivos do FIRMWARE DESEJADO DO SWITCH nela!
   echo.
   pause
   cls
   goto prereq
) else (
  dir /b /s /a "%SWFWFold%%VVER2%\" | findstr .>nul || (
    echo.
    echo Erro de prerequisitos!
    echo Coloque os arquivos do FIRMWARE DESEJADO DO SWITCH na pasta "%SWFWFold%%VVER2%\"!
	echo.
    pause
    cls
    goto prereq
  )
)

:limpeza
cls
echo.
echo Todas as verificacoes concluidas!
echo.
echo Iniciando script...
echo Limpando arquivos desnecessarios...
if exist "1-SD Card\backup\eMMC_ID\restore\BOOT0" del /q "1-SD Card\backup\eMMC_ID\restore\BOOT0"
if exist "1-SD Card\backup\eMMC_ID\restore\BOOT1" del /q "1-SD Card\backup\eMMC_ID\restore\BOOT1"
if exist "1-SD Card\backup\eMMC_ID\restore\rawnand.bin" del /q "1-SD Card\backup\eMMC_ID\restore\rawnand.bin"
if exist "1-SD Card\restore\boot.bis" del /q "1-SD Card\restore\boot.bis"
if exist "1-SD Card\restore\SYSTEM" rd /q /s "1-SD Card\restore\SYSTEM"
if exist "1-SD Card\switch\prod.keys" del /q "1-SD Card\switch\prod.keys"
if exist "1-SD Card\switch\prodinfo.dec" del /q "1-SD Card\switch\prodinfo.dec"

if exist "2-PC Apps\NxNandManager\donor_prod.keys" del /q "2-PC Apps\NxNandManager\donor_prod.keys"
if exist "2-PC Apps\NxNandManager\donor_rawnand.bin" del /q "2-PC Apps\NxNandManager\donor_rawnand.bin"
if exist "2-PC Apps\NxNandManager\prod.keys" del /q "2-PC Apps\NxNandManager\prod.keys"
if exist "2-PC Apps\NxNandManager\prodinfo.dec" del /q "2-PC Apps\NxNandManager\prodinfo.dec"
if exist "2-PC Apps\NxNandManager\prodinfo.enc" del /q "2-PC Apps\NxNandManager\prodinfo.enc"
if exist "2-PC Apps\NxNandManager\prodinfof.dec" del /q "2-PC Apps\NxNandManager\prodinfof.dec"
if exist "2-PC Apps\NxNandManager\prodinfof.enc" del /q "2-PC Apps\NxNandManager\prodinfof.enc"
if exist "2-PC Apps\NxNandManager\safe.dec" del /q "2-PC Apps\NxNandManager\safe.dec"
if exist "2-PC Apps\NxNandManager\safe.enc" del /q "2-PC Apps\NxNandManager\safe.enc"
if exist "2-PC Apps\NxNandManager\system.dec" del /q "2-PC Apps\NxNandManager\system.dec"
if exist "2-PC Apps\NxNandManager\system.enc" del /q "2-PC Apps\NxNandManager\system.enc"
if exist "2-PC Apps\NxNandManager\user.dec" del /q "2-PC Apps\NxNandManager\user.dec"
if exist "2-PC Apps\NxNandManager\user.enc" del /q "2-PC Apps\NxNandManager\user.enc"
if exist "2-PC Apps\NxNandManager\keys.dat" del /q "2-PC Apps\NxNandManager\keys.dat"

if exist "2-PC Apps\EmmcHaccGen\prod.keys" del /q "2-PC Apps\EmmcHaccGen\prod.keys"

if exist "2-PC Apps\EmmcHaccGen\NX-%VVER2%_exFAT" rd /q /s "2-PC Apps\EmmcHaccGen\NX-%VVER2%_exFAT"
if exist "2-PC Apps\EmmcHaccGen\a-%VVER2%_exFAT" rd /q /s "2-PC Apps\EmmcHaccGen\a-%VVER2%_exFAT"
if exist "2-PC Apps\EmmcHaccGen\restore" rd /q /s "2-PC Apps\EmmcHaccGen\restore"
if exist "2-PC Apps\EmmcHaccGen\backup" rd /q /s "2-PC Apps\EmmcHaccGen\backup"

:inicio
echo.

echo Voce esta usando a versao %VVER2% do firmware do Switch.
echo Se nao for esta a versao desejada, interrompa o script com CTRL+C e execute-o com a versao correta!
echo.

echo Qual modelo de APU?
echo 1 - ERISTA
echo 2 - MARIKO
echo 3 - SAIR
CHOICE /C 123 /m "Escolha a opcao: "
IF ERRORLEVEL 3 goto fim
IF ERRORLEVEL 2 goto apum
IF ERRORLEVEL 1 goto apue

:apue
set VAPU=--fw
goto acao

:apum
set VAPU=--mariko --fw
goto acao

:acao
echo.
echo Copiando arquivos...
echo.
copy "prod.keys" "2-PC Apps\EmmcHaccGen" >nul
copy "prod.keys" "2-PC Apps\NxNandManager" >nul
copy "prodinfo.dec" "2-PC Apps\NxNandManager" >nul
copy "donor_prod.keys" "2-PC Apps\NxNandManager" >nul
robocopy "." "2-PC Apps\NxNandManager" donor_rawnand.bin /ETA /NDL /NJH /NJS /NC /NS

cd "2-PC Apps"
cd "NxNandManager"
echo.
echo Extraindo arquivos...
call 1-extract.bat
echo.
echo Flasheando arquivos...
echo.
call 2-flash.bat

echo.
echo Abra o arquivo donor_rawnand.bin no NxNandManager e use as chaves do prod.keys para verificar se tudo esta correto!
echo.
echo Apos tudo verificado, feche o NxNandManager e continue aqui...
cd..

cd "EmmcHaccGen"

set VPROD=--keys prod.keys
set VVER=FW%VVER2%

echo.
echo Iniciando EmmcHaccGen...
EmmcHaccGen.exe %VPROD% --no-autorcm %VAPU% %VVER%

if exist "NX-%VVER2%_exFAT" (
  set VEHGPATH=NX-%VVER2%_exFAT
)
if exist "a-%VVER2%_exFAT" (
  set VEHGPATH=a-%VVER2%_exFAT
)

if exist "%VEHGPATH%" (
echo.

cd "%VEHGPATH%"

echo Movendo arquivos para a pasta RESTORE...
move "boot.bis" "..\..\..\1-SD Card\restore" >nul
xcopy "SYSTEM" "..\..\..\1-SD Card\restore\SYSTEM" /E /H /C /I /K /Y /Q >nul
ren "BOOT0.bin" "BOOT0"
ren "BOOT1.bin" "BOOT1"
move "BOOT0" "..\..\..\1-SD Card\backup\eMMC_ID\restore" >nul
move "BOOT1" "..\..\..\1-SD Card\backup\eMMC_ID\restore" >nul

rd /q /s "SAFE"
rd /q /s "SYSTEM"
rd /q /s "USER"
del /q "BCPKG2-1-Normal-Main.bin"
del /q "BCPKG2-2-Normal-Sub.bin"
del /q "BCPKG2-3-SafeMode-Main.bin"
del /q "BCPKG2-4-SafeMode-Sub.bin"
)

cd..

echo.
echo Movendo RAWNAND para o microSD...
cd..
cd "NxNandManager"
move "donor_rawnand.bin" "..\..\1-SD Card\backup\eMMC_ID\restore\rawnand.bin" >nul

echo.
echo Limpando arquivos desnecessarios na pasta NxNandManager...
echo.
if exist "donor_prod.keys" del /q donor_prod.keys
if exist "keys.dat" del /q keys.dat
if exist "prod.keys" del /q prod.keys
if exist "prodinfo.dec" del /q prodinfo.dec
if exist "prodinfo.enc" del /q prodinfo.enc
if exist "prodinfof.dec" del /q prodinfof.dec
if exist "prodinfof.enc" del /q prodinfof.enc
if exist "safe.dec" del /q safe.dec
if exist "safe.enc" del /q safe.enc
if exist "system.dec" del /q system.dec
if exist "system.enc" del /q system.enc
if exist "user.dec" del /q user.dec
if exist "user.enc" del /q user.enc

cd..
cd EmmcHaccGen
echo Limpando arquivos desnecessarios na pasta EmmcHaccGen...
echo.
if exist "prod.keys" del /q "prod.keys"
if exist "donor_prod.keys" move "donor_prod.keys" "..\..\donor_prod.keys" >nul

if exist "NX-%VVER2%_exFAT" rd /q /s "NX-%VVER2%_exFAT"
if exist "a-%VVER2%_exFAT" rd /q /s "a-%VVER2%_exFAT"
if exist "restore" rd /q /s "restore"
if exist "backup" rd /q /s "backup"

cd..
cd..
echo Movendo arquivos do usuario para o microSD...
if exist "prod.keys" move "prod.keys" "1-SD Card\switch\prod.keys" >nul
if exist "prodinfo.dec" move "prodinfo.dec" "1-SD Card\switch\prodinfo.dec" >nul

echo.
echo ############################################################################################
echo #                                   PROCESSO FINALIZADO!                                   #
echo ############################################################################################
echo.
echo Copie o conteudo da pasta "1-SD Card" para a raiz do microSD e inicie o processo no console!

:fim
echo.
echo Script terminado. Pressione qualquer tecla para fechar a tela.
pause >nul
exit

:fimerro
echo.
echo Script terminado com erro!
echo Corrija os problemas e execute-o novamente.
echo.
pause >nul
exit
